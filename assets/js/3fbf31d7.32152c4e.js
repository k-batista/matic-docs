"use strict";(self.webpackChunkmatic_docs=self.webpackChunkmatic_docs||[]).push([[56576],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return h}});var a=n(67294);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,o=function(e,t){if(null==e)return{};var n,a,o={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var c=a.createContext({}),s=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},p=function(e){var t=s(e.components);return a.createElement(c.Provider,{value:t},e.children)},k={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,c=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),d=s(n),h=o,m=d["".concat(c,".").concat(h)]||d[h]||k[h]||r;return n?a.createElement(m,l(l({ref:t},p),{},{components:n})):a.createElement(m,l({ref:t},p))}));function h(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,l=new Array(r);l[0]=d;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:o,l[1]=i;for(var s=2;s<r;s++)l[s]=n[s];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},74045:function(e,t,n){n.r(t),n.d(t,{assets:function(){return k},contentTitle:function(){return s},default:function(){return m},frontMatter:function(){return c},metadata:function(){return p},toc:function(){return d}});var a=n(87462),o=n(63366),r=(n(67294),n(3905)),l=n(44996),i=["components"],c={id:"checkpoint",title:"Checkpoint",description:"Module that manages checkpoint-related functionalities",keywords:["docs","matic","checkpoint","heimdall"],image:"https://matic.network/banners/matic-network-16x9.png"},s="Checkpoint",p={unversionedId:"pos/heimdall/modules/checkpoint",id:"pos/heimdall/modules/checkpoint",title:"Checkpoint",description:"Module that manages checkpoint-related functionalities",source:"@site/docs/pos/heimdall/modules/checkpoint.md",sourceDirName:"pos/heimdall/modules",slug:"/pos/heimdall/modules/checkpoint",permalink:"/matic-docs/docs/pos/heimdall/modules/checkpoint",draft:!1,editUrl:"https://github.com/maticnetwork/matic-docs/tree/master/docs/pos/heimdall/modules/checkpoint.md",tags:[],version:"current",lastUpdatedBy:"Kennedy Batista",lastUpdatedAt:1686621530,formattedLastUpdatedAt:"Jun 13, 2023",frontMatter:{id:"checkpoint",title:"Checkpoint",description:"Module that manages checkpoint-related functionalities",keywords:["docs","matic","checkpoint","heimdall"],image:"https://matic.network/banners/matic-network-16x9.png"},sidebar:"pos",previous:{title:"Staking",permalink:"/matic-docs/docs/pos/heimdall/modules/staking"},next:{title:"Bor",permalink:"/matic-docs/docs/pos/heimdall/modules/bor"}},k={},d=[{value:"Checkpoint life-cycle",id:"checkpoint-life-cycle",level:2},{value:"Messages",id:"messages",level:2},{value:"MsgCheckpoint",id:"msgcheckpoint",level:3},{value:"MsgCheckpointAck",id:"msgcheckpointack",level:3},{value:"MsgCheckpointNoAck",id:"msgcheckpointnoack",level:3},{value:"Parameters",id:"parameters",level:2},{value:"CLI Commands",id:"cli-commands",level:2},{value:"Params",id:"params",level:3},{value:"Send Checkpoint",id:"send-checkpoint",level:3},{value:"Send <code>ack</code>",id:"send-ack",level:3},{value:"Send <code>no-ack</code>",id:"send-no-ack",level:3},{value:"REST APIs",id:"rest-apis",level:2}],h={toc:d};function m(e){var t=e.components,n=(0,o.Z)(e,i);return(0,r.kt)("wrapper",(0,a.Z)({},h,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"checkpoint"},"Checkpoint"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"checkpoint")," module manages checkpoint related functionalities for Heimdall. It needs Bor chain when a new checkpoint is proposed on Heimdall to verify checkpoint root hash."),(0,r.kt)("p",null,"All related to checkpoint data is explained in details ",(0,r.kt)("a",{parentName:"p",href:"/docs/pos/heimdall/checkpoint"},"here"),"."),(0,r.kt)("h2",{id:"checkpoint-life-cycle"},"Checkpoint life-cycle"),(0,r.kt)("p",null,"Heimdall uses the same leader selection algorithm as Tendermint to select the next proposer. While submitting checkpoints on the Ethereum chain, it may fail due to multiple reasons like gas limit, traffic on Ethereum, high gas fees. That's why the multi-stage checkpoint process is required."),(0,r.kt)("p",null,"Each checkpoint has validator as proposer. If checkpoint on Ethereum chain fails or succeeds, ",(0,r.kt)("inlineCode",{parentName:"p"},"ack")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"no-ack")," transaction would change the proposer on Heimdall for next checkpoint. The following flow chart represents the life cycle of the checkpoint:"),(0,r.kt)("img",{src:(0,l.Z)("img/checkpoint/checkpoint-flowchart.svg")}),(0,r.kt)("h2",{id:"messages"},"Messages"),(0,r.kt)("img",{src:(0,l.Z)("img/checkpoint/checkpoint-module-flow.svg")}),(0,r.kt)("h3",{id:"msgcheckpoint"},"MsgCheckpoint"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"MsgCheckpoint")," handles checkpoint verification on Heimdall. Only this message uses RLP encoding as it needs to be verified on Ethereum chain."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// MsgCheckpoint represents checkpoint transaction\ntype MsgCheckpoint struct {\n    Proposer        types.HeimdallAddress `json:"proposer"`\n    StartBlock      uint64                `json:"startBlock"`\n    EndBlock        uint64                `json:"endBlock"`\n    RootHash        types.HeimdallHash    `json:"rootHash"`\n    AccountRootHash types.HeimdallHash    `json:"accountRootHash"`\n}\n')),(0,r.kt)("p",null,"Once this transaction gets processed on Heimdall, the ",(0,r.kt)("inlineCode",{parentName:"p"},"proposer")," takes ",(0,r.kt)("inlineCode",{parentName:"p"},"votes")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"sigs")," from Tendermint for this transaction and sends checkpoint on the Ethereum chain."),(0,r.kt)("p",null,"Since block contains multiple transactions and verifies this particular transaction on the Ethereum chain, Merkle proof is required. To avoid extra Merkle proof verification on Ethereum, Heimdall only allows one transaction in the block if the transaction type is ",(0,r.kt)("inlineCode",{parentName:"p"},"MsgCheckpoint")),(0,r.kt)("p",null,"To allow this mechanism, Heimdall sets ",(0,r.kt)("inlineCode",{parentName:"p"},"MsgCheckpoint")," transaction as high gas consumed transaction. Check ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/maticnetwork/heimdall/blob/develop/auth/ante.go#L104-L106"},"https://github.com/maticnetwork/heimdall/blob/develop/auth/ante.go#L104-L106")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// fee wanted for checkpoint transaction\ngasWantedPerCheckpoinTx sdk.Gas = 10000000\n\n// checkpoint gas limit\nif stdTx.Msg.Type() == "checkpoint" && stdTx.Msg.Route() == "checkpoint" {\n    gasForTx = gasWantedPerCheckpoinTx\n}\n')),(0,r.kt)("p",null,"This transaction will store proposed checkpoint on ",(0,r.kt)("inlineCode",{parentName:"p"},"checkpointBuffer")," state instead of actual checkpoint list state."),(0,r.kt)("h3",{id:"msgcheckpointack"},"MsgCheckpointAck"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"MsgCheckpointAck")," handles successful checkpoint submission. Here ",(0,r.kt)("inlineCode",{parentName:"p"},"HeaderBlock")," is a checkpoint counter;"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// MsgCheckpointAck represents checkpoint ack transaction if checkpoint is successful\ntype MsgCheckpointAck struct {\n    From        types.HeimdallAddress `json:"from"`\n    HeaderBlock uint64                `json:"headerBlock"`\n    TxHash      types.HeimdallHash    `json:"tx_hash"`\n    LogIndex    uint64                `json:"log_index"`\n}\n')),(0,r.kt)("p",null,"For valid ",(0,r.kt)("inlineCode",{parentName:"p"},"TxHash")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"LogIndex")," for the submitted checkpoint, this transaction verifies the following event and validates checkpoint in ",(0,r.kt)("inlineCode",{parentName:"p"},"checkpointBuffer")," state: ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/maticnetwork/contracts/blob/develop/contracts/root/RootChainStorage.sol#L7-L14"},"https://github.com/maticnetwork/contracts/blob/develop/contracts/root/RootChainStorage.sol#L7-L14")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-jsx"},"event NewHeaderBlock(\n    address indexed proposer,\n    uint256 indexed headerBlockId,\n    uint256 indexed reward,\n    uint256 start,\n    uint256 end,\n    bytes32 root\n);\n")),(0,r.kt)("p",null,"On successful event verification, it updates the actual count of checkpoint, also known as ",(0,r.kt)("inlineCode",{parentName:"p"},"ackCount")," and clears the ",(0,r.kt)("inlineCode",{parentName:"p"},"checkpointBuffer"),"."),(0,r.kt)("h3",{id:"msgcheckpointnoack"},"MsgCheckpointNoAck"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"MsgCheckpointNoAck")," handles un-successful checkpoints or offline proposers. This transaction is only valid after ",(0,r.kt)("inlineCode",{parentName:"p"},"CheckpointBufferTime")," has passed from the following events:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Last successful ",(0,r.kt)("inlineCode",{parentName:"li"},"ack")," transaction"),(0,r.kt)("li",{parentName:"ul"},"Last successful ",(0,r.kt)("inlineCode",{parentName:"li"},"no-ack")," transaction")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},'// MsgCheckpointNoAck represents checkpoint no-ack transaction\ntype MsgCheckpointNoAck struct {\n    From types.HeimdallAddress `json:"from"`\n}\n')),(0,r.kt)("p",null,"This transaction gives the timeout period for the current proposer to send checkpoint/ack before Heimdall chooses a new ",(0,r.kt)("inlineCode",{parentName:"p"},"proposer")," for the next checkpoint."),(0,r.kt)("h2",{id:"parameters"},"Parameters"),(0,r.kt)("p",null,"The checkpoint module contains the following parameters:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Key"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Default value"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"CheckpointBufferTime"),(0,r.kt)("td",{parentName:"tr",align:null},"uint64"),(0,r.kt)("td",{parentName:"tr",align:null},"1000 * time.Second")))),(0,r.kt)("h2",{id:"cli-commands"},"CLI Commands"),(0,r.kt)("h3",{id:"params"},"Params"),(0,r.kt)("p",null,"To print all params:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-go"},"heimdallcli query checkpoint params --trust-node\n")),(0,r.kt)("p",null,"Expected Result:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"checkpoint_buffer_time: 16m40s\n")),(0,r.kt)("h3",{id:"send-checkpoint"},"Send Checkpoint"),(0,r.kt)("p",null,"Following command sends checkpoint transaction on Heimdall:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"heimdallcli tx checkpoint send-checkpoint \\\n    --start-block=<start-block> \\\n    --end-block=<end-block> \\\n    --root-hash=<root-hash> \\\n    --account-root-hash=<account-root-hash> \\\n    --chain-id=<chain-id>\n")),(0,r.kt)("h3",{id:"send-ack"},"Send ",(0,r.kt)("inlineCode",{parentName:"h3"},"ack")),(0,r.kt)("p",null,"Following command sends ack transaction on Heimdall if checkpoint is successful on Ethereum:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"heimdallcli tx checkpoint send-ack \\\n    --tx-hash=<checkpoint-tx-hash>\n    --log-index=<checkpoint-event-log-index>\n    --header=<checkpoint-index> \\\n  --chain-id=<chain-id>\n")),(0,r.kt)("h3",{id:"send-no-ack"},"Send ",(0,r.kt)("inlineCode",{parentName:"h3"},"no-ack")),(0,r.kt)("p",null,"Following command send no-ack transaction on Heimdall:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"heimdallcli tx checkpoint send-noack --chain-id <chain-id>\n")),(0,r.kt)("h2",{id:"rest-apis"},"REST APIs"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Name"),(0,r.kt)("th",{parentName:"tr",align:null},"Method"),(0,r.kt)("th",{parentName:"tr",align:null},"Endpoint"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"It returns the prepared msg for ack checkpoint"),(0,r.kt)("td",{parentName:"tr",align:null},"POST"),(0,r.kt)("td",{parentName:"tr",align:null},"/checkpoint/ack")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"It returns the prepared msg for new checkpoint"),(0,r.kt)("td",{parentName:"tr",align:null},"POST"),(0,r.kt)("td",{parentName:"tr",align:null},"/checkpoint/new")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"It returns the prepared msg for no-ack checkpoint"),(0,r.kt)("td",{parentName:"tr",align:null},"POST"),(0,r.kt)("td",{parentName:"tr",align:null},"/checkpoint/no-ack")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Checkpoint by number"),(0,r.kt)("td",{parentName:"tr",align:null},"GET"),(0,r.kt)("td",{parentName:"tr",align:null},"/checkpoints/<checkpoint-number",">")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Get current checkpoint buffer state"),(0,r.kt)("td",{parentName:"tr",align:null},"GET"),(0,r.kt)("td",{parentName:"tr",align:null},"/checkpoints/buffer")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Get checkpoint counts"),(0,r.kt)("td",{parentName:"tr",align:null},"GET"),(0,r.kt)("td",{parentName:"tr",align:null},"/checkpoints/count")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Get last no-ack details"),(0,r.kt)("td",{parentName:"tr",align:null},"GET"),(0,r.kt)("td",{parentName:"tr",align:null},"/checkpoints/last-no-ack")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Get latest checkpoint"),(0,r.kt)("td",{parentName:"tr",align:null},"GET"),(0,r.kt)("td",{parentName:"tr",align:null},"/checkpoints/latest")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"All checkpoints"),(0,r.kt)("td",{parentName:"tr",align:null},"GET"),(0,r.kt)("td",{parentName:"tr",align:null},"/checkpoints/list")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"It returns the checkpoint parameters"),(0,r.kt)("td",{parentName:"tr",align:null},"GET"),(0,r.kt)("td",{parentName:"tr",align:null},"/checkpoints/parama")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"It returns the prepared checkpoint"),(0,r.kt)("td",{parentName:"tr",align:null},"GET"),(0,r.kt)("td",{parentName:"tr",align:null},"/checkpoints/prepare")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"Get ack count, buffer, validator set, validator count and last-no-ack details"),(0,r.kt)("td",{parentName:"tr",align:null},"GET"),(0,r.kt)("td",{parentName:"tr",align:null},"/overview")))),(0,r.kt)("p",null,"More details about the query and response of the above requests can be found ",(0,r.kt)("a",{parentName:"p",href:"https://heimdall-api.polygon.technology/swagger-ui/#/checkpoint"},"here"),"."),(0,r.kt)("p",null,"All query APIs will provide result in following format:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n    "height": "1",\n    "result": {\n        ...   \n    }\n}\n')))}m.isMDXComponent=!0}}]);